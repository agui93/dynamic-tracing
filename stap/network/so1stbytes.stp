#!/usr/bin/stap


############################################################
#
# syscall.connect sockfd:long serv_addr_uaddr:long addrlen:long name:string uaddr_af:string uaddr_ip:string uaddr_ip_port:string uaddr_ipv6_flowinfo:string uaddr_ipv6_scope_id:string argstr:string
#
############################################################

global connectTime


probe begin {
    printf("\nTracing ...\nHit Ctrl-C to end.\n\n")
}


probe syscall.connect {
    connectTime[tid()] = gettimeofday_ns()
}

probe syscall.connect.return {
    if( connectTime[tid()] ){
        printf("connection lat %d, %d\n", tid(), gettimeofday_ns()-connectTime[tid()] );
        delete connectTime[tid()]
    }
}

probe timer.s(10) {
    exit()
}
